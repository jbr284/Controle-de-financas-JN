<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA - Meta Tags -->
    <meta name="theme-color" content="#e91e63"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Controlo Financeiro (v7.0 - PWA)</title>
    <style>
        /* Estilos gerais do corpo da página */
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f1f1;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }
        /* Contentor principal para centralizar o conteúdo */
        .container {
            max-width: 1600px;
            width: 95%;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
        }
        /* Título principal */
        h1 {
            text-align: center;
            color: #e91e63;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        /* Estilos para os ecrãs de login e registos */
        #login-screen, #records-screen {
            display: none;
        }
        #login-screen.active, #records-screen.active {
            display: block;
        }

        /* --- ECRÃ DE LOGIN --- */
        #login-screen {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
            padding: 30px;
            border: 1px solid #eee;
            border-radius: 12px;
            background-color: #fcfcfc;
        }
        #login-screen h2 {
            color: #e91e63;
            margin-bottom: 25px;
        }
        .login-form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .login-form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .login-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }
        .login-buttons button {
            background-color: #e91e63;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            flex: 1;
        }
        .login-buttons button.secondary {
            background-color: #777;
        }
        .login-buttons button:hover {
            opacity: 0.9;
        }
        #login-error {
            color: #d32f2f;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }
        .register-info {
            font-size: 0.9em;
            color: #888;
            margin-top: 20px;
        }

        /* Estilos do cabeçalho do ecrã de registos */
        #records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        #user-info, #sync-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #user-info span {
            font-weight: bold;
        }

        #user-info button, #sync-buttons button {
            background-color: #2196F3;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        #sync-buttons button.save {
            background-color: #4CAF50;
        }
        #user-info button.logout {
            background-color: #f44336;
        }
        #user-info button:hover, #sync-buttons button:hover {
            opacity: 0.85;
        }
        
        #records-header div {
            margin-right: 20px;
            margin-bottom: 10px;
        }
        #records-header label {
            margin-right: 8px;
            font-weight: bold;
            color: #666;
        }
        #current-date-time {
            font-weight: bold;
            color: #444;
            font-size: 1.1em;
        }
        #month-year-selectors select {
            padding: 9px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-right: 12px;
            background-color: #fdfdfd;
            font-size: 1em;
            cursor: pointer;
        }

        /* Estilos da secção de formulário */
        .form-section {
            background-color: #fdf3f5;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 35px;
            border: 1px solid #fce4ec;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .form-section h2 {
            margin-top: 0;
            color: #e91e63;
            border-bottom: 1px solid #f8bbd0;
            padding-bottom: 12px;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        .form-group {
            margin-bottom: 18px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .form-group label {
            flex: 0 0 140px;
            margin-right: 15px;
            font-weight: bold;
            color: #444;
            font-size: 0.95em;
        }
        .form-group input, .form-group select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-width: 180px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .invalid-field {
            border: 2px solid #d32f2f !important;
            box-shadow: 0 0 5px rgba(211, 47, 47, 0.5);
        }
        .form-group input[type="radio"] {
            flex: unset;
            width: auto;
            margin-right: 8px;
            transform: scale(1.1);
        }
        .form-group .radio-options {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-group .radio-options label {
            flex: unset;
            font-weight: normal;
            margin-right: 25px;
            color: #333;
            cursor: pointer;
        }

        button.add-record {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            display: block;
            margin-top: 25px;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        button.add-record:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        button.add-record:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* --- ESTILOS DA TABELA CORRIGIDOS --- */
        .table-container {
            overflow-x: auto; /* Adiciona scroll horizontal em ecrãs pequenos */
        }
        table {
            width: 100%;
            min-width: 900px; /* Largura mínima para evitar quebra excessiva */
            border-collapse: collapse;
            margin-top: 35px;
            background-color: #ffffff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }
        table th, table td {
            border: 1px solid #e0e0e0;
            padding: 14px 12px;
            text-align: left;
            vertical-align: middle;
            overflow-wrap: break-word; /* Propriedade moderna para quebra de texto */
            word-wrap: break-word;     /* Fallback */
        }
        table th {
            background-color: #e91e63;
            color: white;
            font-weight: bold;
            font-size: 1em;
            text-transform: uppercase;
        }
        
        /* Larguras das colunas reequilibradas */
        table th:nth-child(1) { width: 9%; }  /* Data */
        table th:nth-child(2) { width: 23%; } /* Descrição */
        table th:nth-child(3) { width: 14%; } /* Categoria */
        table th:nth-child(4) { width: 9%; }  /* Receita */
        table th:nth-child(5) { width: 9%; }  /* Débito */
        table th:nth-child(6) { width: 15%; } /* Status */
        table th:nth-child(7) { width: 11%; } /* Saldo */
        table th:nth-child(8) { width: 10%; } /* Ação */

        table tr:nth-child(even) {
            background-color: #fcf4f6;
        }
        table tr:hover {
            background-color: #f5e7eb;
        }
        
        /* Layout dos botões de ação corrigido */
        .action-buttons {
            display: flex;
            flex-wrap: wrap; /* Permite que os botões quebrem para a linha de baixo */
            gap: 5px;
            justify-content: flex-start;
            align-items: center;
        }
        .action-buttons button {
            background-color: #2196F3;
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* Faz os botões ocuparem o espaço disponível */
            text-align: center;
        }
        .action-buttons button.delete {
            background-color: #f44336;
        }
        .action-buttons button.reagendar-btn {
            background-color: #ff9800 !important;
        }
        .action-buttons button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .action-buttons button:active {
            transform: translateY(0);
        }
        
        tfoot td {
            font-weight: bold;
            background-color: #d81b60;
            color: white;
            padding: 15px 12px;
            font-size: 1.1em;
        }
        tfoot td:first-child {
            text-align: right;
            padding-right: 20px;
        }
        .hidden {
            display: none !important;
        }

        /* Estilos para cores de texto de valores */
        .revenue-value { color: #28a745; font-weight: bold; }
        .debit-value { color: #dc3545; font-weight: bold; }
        .balance-positive { color: #007bff; font-weight: bold; }
        .balance-negative { color: #ffc107; font-weight: bold; }
        
        /* ESTILOS DO MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-container {
            background-color: white; padding: 25px 30px; border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); width: 90%; max-width: 500px;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-container { transform: scale(1); }
        .modal-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #e91e63; font-size: 1.5em; }
        .modal-body { margin-bottom: 25px; font-size: 1.1em; line-height: 1.6; color: #555; }
        .modal-body input {
            width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc;
            border-radius: 6px; box-sizing: border-box;
        }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-size: 1em; font-weight: bold; transition: all 0.2s ease;
        }
        .modal-footer button.primary { background-color: #e91e63; color: white; }
        .modal-footer button.primary:hover { background-color: #c2185b; }
        .modal-footer button.secondary { background-color: #f0f0f0; color: #333; border: 1px solid #ddd; }
        .modal-footer button.secondary:hover { background-color: #e0e0e0; }
        .modal-footer button.danger { background-color: #f44336; color: white; }
        .modal-footer button.danger:hover { background-color: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Controlo Financeiro Família Rosa</h1>

        <section id="login-screen" class="active">
            <h2>Acesso ao Sistema</h2>
            <div class="login-form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="seu@email.com">
            </div>
            <div class="login-form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="Mínimo 6 caracteres">
            </div>
            <div class="login-buttons">
                <button id="login-button">Entrar</button>
                <button id="register-button" class="secondary">Registar</button>
            </div>
            <p id="login-error"></p>
            <p class="register-info">O registo de novas contas requer um e-mail pré-aprovado.</p>
        </section>

        <section id="records-screen">
            <div id="records-header">
                <div id="user-info">
                    <span id="user-email"></span>
                    <button id="logout-button" class="logout">Sair</button>
                </div>
                <div id="sync-buttons">
                    <button id="save-data-button" class="save">Guardar na Nuvem</button>
                    <button id="load-data-button">Carregar da Nuvem</button>
                </div>
                <div>
                    <span id="current-date-time"></span>
                </div>
                <div id="month-year-selectors">
                    <label for="month-select">Mês:</label>
                    <select id="month-select"></select>
                    <label for="year-select">Ano:</label>
                    <select id="year-select"></select>
                </div>
            </div>

            <div class="form-section">
                <h2>Registar Nova Transação</h2>
                <div class="form-group">
                    <label for="day-select">Dia do Registo:</label>
                    <select id="day-select"></select>
                </div>
                <div class="form-group">
                    <label>Tipo de Registo:</label>
                    <div class="radio-options">
                        <input type="radio" id="type-revenue" name="record-type" value="Receita" checked>
                        <label for="type-revenue">Receita</label>
                        <input type="radio" id="type-debit" name="record-type" value="Débito">
                        <label for="type-debit">Débito</label>
                    </div>
                </div>

                <div id="debit-options" class="hidden">
                    <div class="form-group">
                        <label for="debit-type">Opção de Débito:</label>
                        <select id="debit-type">
                            <option value="à vista">À vista</option>
                            <option value="a prazo">A prazo</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>
                    <div id="debit-aprazo-fields" class="hidden form-group">
                        <label for="debit-due-day-aprazo">Dia do Débito:</label>
                        <select id="debit-due-day-aprazo"></select>
                    </div>
                    <div id="debit-parcelado-fields" class="hidden">
                        <div class="form-group">
                            <label for="num-installments">Nº de Parcelas:</label>
                            <input type="number" id="num-installments" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="debit-due-day-parcelado">Dia do Débito (Parcela):</label>
                            <select id="debit-due-day-parcelado"></select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descrição:</label>
                    <input type="text" id="description" placeholder="Ex: Salário, Aluguer">
                </div>
                <div class="form-group">
                    <label for="category">Categoria:</label>
                    <input type="text" id="category" placeholder="Ex: Casa, Alimentação">
                </div>
                <div class="form-group">
                    <label for="amount">Valor Monetário:</label>
                    <input type="number" id="amount" step="0.01" min="0">
                </div>
                <button class="add-record" id="add-record-button">Adicionar Registo</button>
            </div>

            <h2>Registos Financeiros</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Receita (R$)</th>
                            <th>Débito (R$)</th>
                            <th>Status</th>
                            <th>Saldo (R$)</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body">
                        </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3">Total do Mês:</td>
                            <td id="total-revenue">0,00</td>
                            <td id="total-debit">0,00</td>
                            <td></td>
                            <td id="final-balance">0,00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>

    <script type="module">
        // Importar funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // =================================================================================
        //  PASSO 1: CONFIGURAÇÃO DO FIREBASE
        // =================================================================================
const firebaseConfig = {
  apiKey: "AIzaSyB6NHzJc6MlK222u0qoiL7BEK9QHEY1Gjk",
  authDomain: "controle-financeiro-jn.firebaseapp.com",
  projectId: "controle-financeiro-jn",
  storageBucket: "controle-financeiro-jn.firebasestorage.app",
  messagingSenderId: "463845176681",
  appId: "1:463845176681:web:cf2a2461e264176a8af9f8"
};


        // Inicializar o Firebase e os seus serviços
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variável global para guardar o ID do utilizador logado ---
        let currentUserId = null;

        // =================================================================================
        //  LÓGICA DE AUTENTICAÇÃO E SINCRONIZAÇÃO
        // =================================================================================

        // --- Referências aos novos elementos do DOM ---
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const logoutButton = document.getElementById('logout-button');
        const saveDataButton = document.getElementById('save-data-button');
        const loadDataButton = document.getElementById('load-data-button');
        const userEmailSpan = document.getElementById('user-email');
        const loginError = document.getElementById('login-error');

        // --- Funções de Autenticação ---
        
        async function handleRegister() {
            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                showLoginError("Por favor, insira um email válido e uma senha com no mínimo 6 caracteres.");
                return;
            }
            
            showModal('A verificar...', 'Aguarde enquanto verificamos a sua permissão de registo.', [], { closeOnClick: false });

            try {
                const allowedUsersRef = collection(db, "allowedUsers");
                const q = query(allowedUsersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    closeModal();
                    showLoginError("Este email não tem permissão para se registar.");
                    return;
                }

                closeModal();
                await createUserWithEmailAndPassword(auth, email, password);
                showModal('Sucesso!', `Utilizador ${email} registado. Já está com a sessão iniciada.`, [{ text: 'OK', class: 'primary' }]);

            } catch (error) {
                closeModal();
                console.error("Erro no registo:", error);
                showLoginError(getFriendlyAuthError(error.code));
            }
        }

        function handleLogin() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showLoginError("Por favor, insira o email e a senha.");
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    console.log("Utilizador com sessão iniciada com sucesso:", userCredential.user);
                })
                .catch((error) => {
                    console.error("Erro no login:", error);
                    showLoginError(getFriendlyAuthError(error.code));
                });
        }

        function handleLogout() {
            signOut(auth).then(() => {
                console.log("Logout realizado com sucesso.");
                currentUserId = null;
                localStorage.clear(); 
            }).catch((error) => {
                console.error("Erro no logout:", error);
                showModal('Erro', 'Ocorreu um erro ao tentar sair.', [{ text: 'OK', class: 'danger' }]);
            });
        }

        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }

        function hideLoginError() {
            loginError.textContent = '';
            loginError.style.display = 'none';
        }

        function getFriendlyAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return 'O formato do email é inválido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    return 'Email ou senha incorretos.';
                case 'auth/email-already-in-use':
                    return 'Este email já está registado.';
                case 'auth/weak-password':
                    return 'A senha precisa de ter no mínimo 6 caracteres.';
                default:
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

        // --- Funções de Sincronização com Firestore ---

        async function saveDataToFirestore() {
            if (!currentUserId) {
                showModal('Erro', 'Precisa de ter a sessão iniciada para guardar os dados.', [{ text: 'OK', class: 'danger' }]);
                return;
            }

            showModal('A guardar...', 'Aguarde enquanto os seus dados são guardados na nuvem.', [], { closeOnClick: false });

            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('financeRecords_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }

            try {
                const userDocRef = doc(db, "userFinances", currentUserId);
                await setDoc(userDocRef, { financialData: allData });
                closeModal();
                showModal('Sucesso!', 'Os seus dados foram guardados na nuvem com sucesso.', [{ text: 'OK', class: 'primary' }]);
            } catch (error) {
                console.error("Erro ao guardar dados no Firestore: ", error);
                closeModal();
                showModal('Erro', 'Não foi possível guardar os dados. Verifique a sua ligação e tente novamente.', [{ text: 'OK', class: 'danger' }]);
            }
        }

        async function loadDataFromFirestore() {
            if (!currentUserId) {
                showModal('Erro', 'Precisa de ter a sessão iniciada para carregar os dados.', [{ text: 'OK', class: 'danger' }]);
                return;
            }

            showModal('A carregar...', 'A buscar os seus dados na nuvem. Aguarde...', [], { closeOnClick: false });

            try {
                const userDocRef = doc(db, "userFinances", currentUserId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const dataFromCloud = docSnap.data().financialData;
                    localStorage.clear();
                    for (const key in dataFromCloud) {
                        localStorage.setItem(key, dataFromCloud[key]);
                    }
                    closeModal();
                    showModal('Sucesso!', 'Dados carregados da nuvem. O ecrã será atualizado.', [{ text: 'OK', class: 'primary', onClick: renderRecords }]);
                } else {
                    closeModal();
                    showModal('Aviso', 'Nenhum dado encontrado na nuvem para este utilizador.', [{ text: 'OK', class: 'primary' }]);
                }
            } catch (error) {
                console.error("Erro ao carregar dados do Firestore: ", error);
                closeModal();
                showModal('Erro', 'Não foi possível carregar os dados. Verifique a sua ligação e tente novamente.', [{ text: 'OK', class: 'danger' }]);
            }
        }

        // --- Observador de Estado de Autenticação ---
        onAuthStateChanged(auth, (user) => {
            hideLoginError();
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                loginScreen.classList.remove('active');
                recordsScreen.classList.add('active');
                initRecordsScreen();
            } else {
                currentUserId = null;
                loginScreen.classList.add('active');
                recordsScreen.classList.remove('active');
            }
        });

        // =================================================================================
        //  O SEU CÓDIGO ORIGINAL (QUASE INTACTO)
        // =================================================================================

        const loginScreen = document.getElementById('login-screen');
        const recordsScreen = document.getElementById('records-screen');
        const currentDateTimeSpan = document.getElementById('current-date-time');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const daySelect = document.getElementById('day-select');
        const typeRevenueRadio = document.getElementById('type-revenue');
        const typeDebitRadio = document.getElementById('type-debit');
        const debitOptionsDiv = document.getElementById('debit-options');
        const debitTypeSelect = document.getElementById('debit-type');
        const debitAPrazoFields = document.getElementById('debit-aprazo-fields');
        const debitDueDayAPrazoSelect = document.getElementById('debit-due-day-aprazo');
        const debitParceladoFields = document.getElementById('debit-parcelado-fields');
        const numInstallmentsInput = document.getElementById('num-installments');
        const debitDueDayParceladoSelect = document.getElementById('debit-due-day-parcelado');
        const descriptionInput = document.getElementById('description');
        const categoryInput = document.getElementById('category');
        const amountInput = document.getElementById('amount');
        const addRecordButton = document.getElementById('add-record-button');
        const recordsTableBody = document.getElementById('records-table-body');
        const totalRevenueTd = document.getElementById('total-revenue');
        const totalDebitTd = document.getElementById('total-debit');
        const finalBalanceTd = document.getElementById('final-balance');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalFooter = document.getElementById('modal-footer');

        let currentMonth;
        let currentYear;

        function closeModal() {
            modal.classList.remove('active');
        }

        function showModal(title, bodyContent, buttons = [], options = {}) {
            modalTitle.textContent = title;
            
            modalBody.innerHTML = '';
            if (typeof bodyContent === 'string') {
                modalBody.textContent = bodyContent;
            } else if (bodyContent instanceof HTMLElement) {
                modalBody.appendChild(bodyContent);
            }

            modalFooter.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = btnInfo.class;
                button.onclick = (e) => {
                    e.stopPropagation();
                    if (btnInfo.onClick) {
                        btnInfo.onClick();
                    }
                    if (options.closeOnClick !== false) {
                       closeModal();
                    }
                };
                modalFooter.appendChild(button);
            });
            
            modal.classList.add('active');
        }

        function formatCurrency(value) {
            return value.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function updateDateTime() {
            const now = new Date();
            currentDateTimeSpan.textContent = now.toLocaleString('pt-PT', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function populateDaySelect() {
            daySelect.innerHTML = '';
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                daySelect.appendChild(option);
            }
            const today = new Date();
            if (currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                daySelect.value = today.getDate();
            } else {
                daySelect.value = 1;
            }
        }

        function populateMonthYearSelectors() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();

            monthSelect.innerHTML = '';
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            monthNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                if (index === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });

            yearSelect.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            populateDaySelect();
            populateDebitDueDaySelects();
        }

        function populateDebitDueDaySelects() {
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            debitDueDayAPrazoSelect.innerHTML = '';
            debitDueDayParceladoSelect.innerHTML = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const option1 = document.createElement('option');
                option1.value = i;
                option1.textContent = i;
                debitDueDayAPrazoSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = i;
                option2.textContent = i;
                debitDueDayParceladoSelect.appendChild(option2);
            }
            const today = new Date();
            if (currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                debitDueDayAPrazoSelect.value = today.getDate();
                debitDueDayParceladoSelect.value = today.getDate();
            } else {
                debitDueDayAPrazoSelect.value = 1;
                debitDueDayParceladoSelect.value = 1;
            }
        }

        function getLocalStorageKey() {
            return `financeRecords_${currentYear}_${currentMonth}`;
        }

        function getRecords() {
            const key = getLocalStorageKey();
            const recordsJSON = localStorage.getItem(key);
            return recordsJSON ? JSON.parse(recordsJSON) : [];
        }

        function saveRecords(records) {
            const key = getLocalStorageKey();
            localStorage.setItem(key, JSON.stringify(records));
        }

        function getRecordsForMonth(year, month) {
            const key = `financeRecords_${year}_${month}`;
            const recordsJSON = localStorage.getItem(key);
            return recordsJSON ? JSON.parse(recordsJSON) : [];
        }

        function saveRecordsForMonth(records, year, month) {
            const key = `financeRecords_${year}_${month}`;
            localStorage.setItem(key, JSON.stringify(records));
        }

        function renderRecords() {
            const records = getRecords().sort((a, b) => {
                const dateA = new Date(currentYear, currentMonth, a.day);
                const dateB = new Date(currentYear, currentMonth, b.day);
                return dateA - dateB;
            });
            recordsTableBody.innerHTML = '';

            let currentBalance = 0;
            let totalRevenue = 0;
            let totalDebit = 0;

            records.forEach((record) => {
                if (record.type === 'Receita') {
                    currentBalance += record.amount;
                    totalRevenue += record.amount;
                } else if (record.type === 'Débito') {
                    const debitValue = (record.debitType === 'parcelado' ? record.installmentValue : record.amount);
                    currentBalance -= debitValue;
                    totalDebit += debitValue;
                }

                const row = recordsTableBody.insertRow();
                row.dataset.id = record.id;

                const displayDay = (record.type === 'Débito' && record.scheduledDay) ? record.scheduledDay : record.day;
                const date = new Date(currentYear, currentMonth, displayDay);
                const formattedDate = date.toLocaleDateString('pt-PT');
                row.insertCell().textContent = formattedDate;

                row.insertCell().textContent = record.description;
                row.insertCell().textContent = record.category;

                const revenueCell = row.insertCell();
                if (record.type === 'Receita') {
                    revenueCell.textContent = formatCurrency(record.amount);
                    revenueCell.classList.add('revenue-value');
                } else {
                    revenueCell.textContent = '';
                }

                const debitCell = row.insertCell();
                let debitAmountDisplay = '';
                if (record.type === 'Débito') {
                    debitAmountDisplay = (record.debitType === 'parcelado' ? formatCurrency(record.installmentValue) : formatCurrency(record.amount));
                    debitCell.classList.add('debit-value');
                }
                debitCell.textContent = debitAmountDisplay;

                const statusCell = row.insertCell();
                let statusText = '';
                if (record.type === 'Receita') {
                    statusText = 'Crédito OK';
                    statusCell.textContent = statusText;
                } else if (record.type === 'Débito') {
                    const scheduledDate = new Date(record.year || currentYear, record.month || currentMonth, record.scheduledDay || record.day);
                    const formattedDueDate = scheduledDate.toLocaleDateString('pt-PT');

                    if (record.debitType === 'à vista') {
                        statusText = 'Pagamento realizado';
                        statusCell.textContent = statusText;
                    } else if (record.debitType === 'a prazo') {
                        statusText = `Débito agendado para ${formattedDueDate}`;
                        statusCell.textContent = statusText;
                    } else if (record.debitType === 'parcelado') {
                        statusText = `Total da Compra: ${formatCurrency(record.amount)}<br>
                                      Vencimento: ${formattedDueDate}<br>
                                      Parcela: ${record.currentInstallment} / ${record.installmentsCount}`;
                        statusCell.innerHTML = statusText;
                    }
                }
                
                if (record.type === 'Débito' && (record.debitType === 'a prazo' || record.debitType === 'parcelado')) {
                    const rescheduleButton = document.createElement('button');
                    rescheduleButton.textContent = 'Reagendar';
                    rescheduleButton.classList.add('reagendar-btn');
                    statusCell.appendChild(document.createElement('br'));
                    statusCell.appendChild(rescheduleButton);
                }

                const balanceCell = row.insertCell();
                balanceCell.textContent = formatCurrency(currentBalance);
                balanceCell.classList.add(currentBalance >= 0 ? 'balance-positive' : 'balance-negative');
                
                const actionCell = row.insertCell();
                actionCell.classList.add('action-buttons');
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Editar';
                editButton.onclick = () => editRecord(record.id);
                actionCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Excluir';
                deleteButton.classList.add('delete');
                deleteButton.onclick = () => deleteRecord(record.id);
                actionCell.appendChild(deleteButton);
            });

            const finalMonthBalance = totalRevenue - totalDebit;
            totalRevenueTd.textContent = formatCurrency(totalRevenue);
            totalDebitTd.textContent = formatCurrency(totalDebit);
            finalBalanceTd.textContent = formatCurrency(finalMonthBalance);
            finalBalanceTd.classList.remove('balance-positive', 'balance-negative');
            finalBalanceTd.classList.add(finalMonthBalance >= 0 ? 'balance-positive' : 'balance-negative');
        }

        function addRecord() {
            descriptionInput.classList.remove('invalid-field');
            categoryInput.classList.remove('invalid-field');
            amountInput.classList.remove('invalid-field');

            const day = parseInt(daySelect.value);
            const type = typeRevenueRadio.checked ? 'Receita' : 'Débito';
            const description = descriptionInput.value.trim();
            const category = categoryInput.value.trim();
            const amount = parseFloat(amountInput.value);

            let isValid = true;

            if (!description) {
                descriptionInput.classList.add('invalid-field');
                isValid = false;
            }
            if (!category) {
                categoryInput.classList.add('invalid-field');
                isValid = false;
            }
            if (isNaN(amount) || amount <= 0) {
                amountInput.classList.add('invalid-field');
                isValid = false;
            }

            if (!isValid) {
                showModal('Erro de Validação', 'Por favor, preencha todos os campos destacados.', [{ text: 'OK', class: 'primary' }]);
                return;
            }

            if (type === 'Receita' || debitTypeSelect.value === 'à vista' || debitTypeSelect.value === 'a prazo') {
                let currentRecords = getRecords();
                if (type === 'Receita') {
                    currentRecords.push({
                        id: Date.now(), day, type, description, category, amount
                    });
                } else {
                    const debitType = debitTypeSelect.value;
                    if (debitType === 'à vista') {
                        currentRecords.push({
                            id: Date.now(), day, type, debitType, description, category, amount
                        });
                    } else if (debitType === 'a prazo') {
                        const scheduledDay = parseInt(debitDueDayAPrazoSelect.value);
                        currentRecords.push({
                            id: Date.now(), day, type, debitType, description, category, amount,
                            scheduledDay, scheduledMonth: currentMonth, scheduledYear: currentYear, isPaid: false
                        });
                    }
                }
                saveRecords(currentRecords);
            } else if (type === 'Débito' && debitTypeSelect.value === 'parcelado') {
                const numInstallments = parseInt(numInstallmentsInput.value);
                const debitDueDay = parseInt(debitDueDayParceladoSelect.value);

                if (isNaN(numInstallments) || numInstallments <= 0) {
                    showModal('Erro de Validação', 'Número de parcelas inválido.', [{ text: 'OK', class: 'primary' }]);
                    return;
                }
                if (numInstallments > 60) {
                    showModal('Erro de Validação', 'O número máximo de parcelas é 60.', [{ text: 'OK', class: 'primary' }]);
                    return;
                }

                const installmentValue = amount / numInstallments;
                const transactionGroupId = Date.now();

                for (let i = 0; i < numInstallments; i++) {
                    let installmentMonth = currentMonth + i;
                    let installmentYear = currentYear;
                    while (installmentMonth > 11) {
                        installmentMonth -= 12;
                        installmentYear++;
                    }
                    let targetMonthRecords = getRecordsForMonth(installmentYear, installmentMonth);
                    targetMonthRecords.push({
                        id: Date.now() + i, transactionGroupId,
                        day: debitDueDay, month: installmentMonth, year: installmentYear,
                        type: 'Débito', debitType: 'parcelado', description, category, amount,
                        installmentValue: installmentValue, installmentsCount: numInstallments,
                        currentInstallment: i + 1, scheduledDay: debitDueDay, isPaid: false
                    });
                    saveRecordsForMonth(targetMonthRecords, installmentYear, installmentMonth);
                }
            }
            
            renderRecords();
            clearForm();
        }

        function editRecord(id) {
            const records = getRecords();
            const recordToEdit = records.find(record => record.id === id);

            if (!recordToEdit) {
                showModal('Erro', 'Registo não encontrado para edição.', [{ text: 'OK', class: 'primary' }]);
                return;
            }

            if (recordToEdit.debitType === 'parcelado') {
                showModal(
                    'Aviso sobre Edição',
                    'A edição de transações parceladas não é permitida. Exclua todas as parcelas e registe novamente.',
                    [
                        { 
                            text: 'Excluir Todas as Parcelas', 
                            class: 'danger', 
                            onClick: () => deleteAllInstallments(recordToEdit.transactionGroupId, recordToEdit.currentInstallment) 
                        },
                        { text: 'Cancelar', class: 'secondary' }
                    ]
                );
                return;
            }

            daySelect.value = recordToEdit.day;
            descriptionInput.value = recordToEdit.description;
            categoryInput.value = recordToEdit.category;
            amountInput.value = recordToEdit.amount;

            if (recordToEdit.type === 'Receita') {
                typeRevenueRadio.checked = true;
                debitOptionsDiv.classList.add('hidden');
            } else {
                typeDebitRadio.checked = true;
                debitOptionsDiv.classList.remove('hidden');
                debitTypeSelect.value = recordToEdit.debitType;
                toggleDebitFields();

                if (recordToEdit.debitType === 'a prazo') {
                    debitDueDayAPrazoSelect.value = recordToEdit.scheduledDay;
                }
            }

            addRecordButton.textContent = 'Atualizar Registo';
            addRecordButton.onclick = () => updateRecord(id);
        }

        function updateRecord(id) {
            let records = getRecords();
            const recordIndex = records.findIndex(record => record.id === id);

            if (recordIndex === -1) {
                showModal('Erro', 'Registo não encontrado para atualização.', [{ text: 'OK', class: 'primary' }]);
                return;
            }

            const day = parseInt(daySelect.value);
            const type = typeRevenueRadio.checked ? 'Receita' : 'Débito';
            const description = descriptionInput.value.trim();
            const category = categoryInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (!day || !description || !category || isNaN(amount) || amount <= 0) {
                showModal('Erro de Validação', 'Preencha todos os campos.', [{ text: 'OK', class: 'primary' }]);
                return;
            }

            let updatedRecord = {
                ...records[recordIndex],
                day, type, description, category, amount
            };

            if (type === 'Débito') {
                const debitType = debitTypeSelect.value;
                updatedRecord.debitType = debitType;

                if (debitType === 'à vista') {
                    delete updatedRecord.scheduledDay; delete updatedRecord.scheduledMonth;
                    delete updatedRecord.scheduledYear; delete updatedRecord.isPaid;
                } else if (debitType === 'a prazo') {
                    updatedRecord.scheduledDay = parseInt(debitDueDayAPrazoSelect.value);
                    updatedRecord.scheduledMonth = currentMonth; 
                    updatedRecord.scheduledYear = currentYear;
                    updatedRecord.isPaid = false;
                }
            } else {
                delete updatedRecord.debitType; delete updatedRecord.scheduledDay;
                delete updatedRecord.scheduledMonth; delete updatedRecord.scheduledYear;
                delete updatedRecord.isPaid;
            }

            records[recordIndex] = updatedRecord;
            saveRecords(records); 
            renderRecords(); 
            clearForm(); 
            addRecordButton.textContent = 'Adicionar Registo';
            addRecordButton.onclick = addRecord;
        }

        function deleteRecord(id) {
            const records = getRecords();
            const recordToDelete = records.find(record => record.id === id);

            if (!recordToDelete) return;

            if (recordToDelete.debitType === 'parcelado' && recordToDelete.transactionGroupId) {
                showModal(
                    'Excluir Parcela',
                    'Esta transação é uma parcela. O que deseja fazer?',
                    [
                        { 
                            text: 'Excluir Apenas Esta Parcela', 
                            class: 'secondary', 
                            onClick: () => {
                                let currentRecords = getRecords().filter(r => r.id !== id);
                                saveRecords(currentRecords);
                                renderRecords();
                            }
                        },
                        { 
                            text: 'Excluir Todas as Futuras', 
                            class: 'danger', 
                            onClick: () => deleteAllInstallments(recordToDelete.transactionGroupId, recordToDelete.currentInstallment) 
                        },
                        { text: 'Cancelar', class: 'primary' }
                    ]
                );
            } else {
                showModal(
                    'Confirmar Exclusão', 
                    'Tem a certeza de que deseja excluir este registo?',
                    [
                         { 
                            text: 'Excluir', 
                            class: 'danger', 
                            onClick: () => {
                                let currentRecords = getRecords().filter(r => r.id !== id);
                                saveRecords(currentRecords);
                                renderRecords();
                            }
                        },
                        { text: 'Cancelar', class: 'secondary' }
                    ]
                );
            }
        }
        
        function deleteAllInstallments(groupId, startInstallment) {
            let month = currentMonth;
            let year = currentYear;

            for (let i = 0; i < 60; i++) {
                let records = getRecordsForMonth(year, month);
                const filteredRecords = records.filter(r => r.transactionGroupId !== groupId || r.currentInstallment < startInstallment);
                saveRecordsForMonth(filteredRecords, year, month);

                month++;
                if (month > 11) {
                    month = 0;
                    year++;
                }
            }

            renderRecords();
            showModal('Sucesso', 'Todas as parcelas futuras foram excluídas.', [{text: 'OK', class: 'primary'}]);
        }

        function showReschedulePrompt(recordId) {
            const records = getRecords();
            const recordToReschedule = records.find(record => record.id === id);

            if (!recordToReschedule) {
                showModal('Erro', 'Registo não encontrado.', [{ text: 'OK', class: 'primary' }]);
                return;
            }
            
            const bodyContainer = document.createElement('div');
            bodyContainer.innerHTML = `<p>Reagendar "${recordToReschedule.description}" para que dia do próximo mês?</p>`;
            const input = document.createElement('input');
            input.type = 'number'; input.min = 1; input.max = 31;
            input.placeholder = 'Digite o dia (1-31)';
            bodyContainer.appendChild(input);

            showModal( 'Reagendar Débito', bodyContainer,
                [
                    {
                        text: 'Confirmar',
                        class: 'primary',
                        onClick: () => {
                            const newDay = parseInt(input.value);
                            if (isNaN(newDay) || newDay < 1 || newDay > 31) {
                                showModal('Erro', 'Dia inválido.', [{ text: 'OK', class: 'primary' }]);
                                return;
                            }
                            
                            let nextMonth = currentMonth + 1;
                            let nextYear = currentYear;
                            if (nextMonth > 11) { nextMonth = 0; nextYear++; }

                            rescheduleRecord(recordToReschedule, newDay, nextMonth, nextYear);
                        }
                    },
                    { text: 'Cancelar', class: 'secondary' }
                ]
            );
        }

        function rescheduleRecord(record, newDay, newMonth, newYear) {
            let currentMonthRecords = getRecords().filter(r => r.id !== record.id);
            saveRecords(currentMonthRecords);

            const newRecord = { ...record };
            newRecord.id = Date.now();
            newRecord.day = newDay; newRecord.scheduledDay = newDay; 
            newRecord.scheduledMonth = newMonth; newRecord.scheduledYear = newYear;
            newRecord.isPaid = false; 

            let targetMonthRecords = getRecordsForMonth(newYear, newMonth);
            targetMonthRecords.push(newRecord); 
            saveRecordsForMonth(targetMonthRecords, newYear, newMonth);

            renderRecords(); 
            showModal('Sucesso', `Registo reagendado com sucesso.`, [{ text: 'OK', class: 'primary' }]);
        }

        function clearForm() {
            const today = new Date();
            if (currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                daySelect.value = today.getDate();
            } else {
                daySelect.value = 1;
            }

            typeRevenueRadio.checked = true;
            debitOptionsDiv.classList.add('hidden'); 
            debitAPrazoFields.classList.add('hidden');
            debitParceladoFields.classList.add('hidden');

            descriptionInput.value = '';
            categoryInput.value = '';
            amountInput.value = '';
            numInstallmentsInput.value = '1';

            addRecordButton.textContent = 'Adicionar Registo';
            addRecordButton.onclick = addRecord;
        }

        function toggleDebitFields() {
            const debitType = debitTypeSelect.value;
            debitAPrazoFields.classList.add('hidden');
            debitParceladoFields.classList.add('hidden');

            if (debitType === 'a prazo') {
                debitAPrazoFields.classList.remove('hidden');
            } else if (debitType === 'parcelado') {
                debitParceladoFields.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        registerButton.addEventListener('click', handleRegister);
        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        saveDataButton.addEventListener('click', saveDataToFirestore);
        loadDataButton.addEventListener('click', loadDataFromFirestore);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        typeRevenueRadio.addEventListener('change', () => {
            debitOptionsDiv.classList.add('hidden');
            debitAPrazoFields.classList.add('hidden');
            debitParceladoFields.classList.add('hidden');
        });

        typeDebitRadio.addEventListener('change', () => {
            debitOptionsDiv.classList.remove('hidden');
            toggleDebitFields();
        });

        debitTypeSelect.addEventListener('change', toggleDebitFields);

        addRecordButton.onclick = addRecord;

        monthSelect.addEventListener('change', () => {
            currentMonth = parseInt(monthSelect.value);
            populateDaySelect();
            populateDebitDueDaySelects();
            renderRecords();
        });

        yearSelect.addEventListener('change', () => {
            currentYear = parseInt(yearSelect.value);
            populateDaySelect();
            populateDebitDueDaySelects();
            renderRecords();
        });

        // --- Initialization ---
        function initRecordsScreen() {
            populateMonthYearSelectors();
            renderRecords();
            clearForm();
        }
        
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // CAMINHO CORRIGIDO
                navigator.serviceWorker.register('/Controle-de-financas-JN/sw.js').then(registration => {
                    console.log('ServiceWorker registado com sucesso: ', registration.scope);
                }, err => {
                    console.log('Falha ao registar o ServiceWorker: ', err);
                });
            });
        }

        // Inicia o relógio apenas uma vez
        setInterval(updateDateTime, 1000);

    </script>
</body>
</html>
